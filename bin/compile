#!/usr/bin/env bash

set -euo pipefail

readonly BUILD_DIR=$1
readonly ENV_DIR=$3
readonly SOURCE_MAPS_PATH_FILE=".source-maps-uploader"
readonly ROLLBAR_POST_SERVER_TOKEN=$(cat ${ENV_DIR}/ROLLBAR_POST_SERVER_TOKEN)

if [[ ! -f "${ENV_DIR}/ROLLBAR_POST_SERVER_TOKEN" ]]; then
  echo "-----> The ROLLBAR_POST_SERVER_TOKEN variable is not defined. Please add to it."
  echo "       Source maps NOT uploaded"
  exit 1
fi

if [[ -f "${ENV_DIR}/SOURCE_MAPS_DOMAIN}" ]]; then
  readonly DOMAIN=$(cat ${ENV_DIR}/SOURCE_MAPS_DOMAIN)
else
  readonly DOMAIN="herokuapp.com"
  echo "-----> WARNING! The SOURCE_MAPS_DOMAIN variable is not defined. So we are using herokuapp.com instead."
fi

cd ${BUILD_DIR}

readonly SOURCE_MAPS_PATH=$(cat ${SOURCE_MAPS_PATH_FILE})

echo "-----> Uploading source maps..."

for source_map in $(ls $SOURCE_MAPS_PATH/*.map); do
  echo "       Uploading file ${source_map}"

  curl --silent --output /dev/null --show-error --fail https://api.rollbar.com/api/1/sourcemap \
    -F access_token=${ROLLBAR_POST_SERVER_TOKEN} \
    -F version=${SOURCE_VERSION} \
    -F minified_url=//${DOMAIN}/${source_map%.map} \
    -F source_map=@${source_map}
done

echo "       Source maps uploading completed"
